
%%%%%%%%%%%%%%%%%%%%%
and: 
\begin{align*}
    \lim_{\delta_T\rightarrow 0^{+}} \Delta W(\delta_T)& = \int_0^{\beta \Delta_{it}+\gamma_{it}}G(c)dc - \lim_{\delta_T\rightarrow 0^{+}}\delta_T \int_0^{\beta \Delta_{it}/\delta_T}G(c_1)dc_1,
\end{align*}
where the second term on the right-hand side is by the change of variable that $c_1 = c/\delta_T$. Plug the expression $G(c) = 1-\exp(-c/\gamma_{it})$ into the first term  of the right-hand side, we obtain that 
\begin{align*}
    \int_0^{\beta \Delta_{it}+\gamma_{it}}G(c)dc 
        &= \beta \Delta_{it} + \gamma_{it}\exp(-\frac{\beta \Delta_{it}+\gamma_{it}}{\gamma_{it}}) \\
        & > \beta \Delta_{it}  =\delta_T \int_0^\frac{\beta \Delta_{it}}{\delta_T}dc\\
        & \geq \delta_T\int_0^\frac{\beta \Delta_{it}}{\delta_T} G(c)dc \\
        &= \beta \Delta_{it}+\delta_{T}\gamma_{it}(\exp \left(-\frac{\Delta_{it}}{\delta_T\gamma_{it}} \right)-1))
\end{align*}
Note that the right limit $\lim_{\delta_T\rightarrow 0^{+}}\beta \Delta_{it}+\delta_{T}\gamma_{it}(\exp \left(-\frac{\Delta_{it}}{\delta_T\gamma_{it}} \right)-1)) = \Delta_{it}$, hence we have 
\begin{equation*}
    \lim_{\delta_T\rightarrow 0^{+}} \Delta W(\delta_T)>0.
\end{equation*} 


We immediately know that $\Delta W_T(\delta_T)|_{\delta_T=1} = 0$. Now we consider $\delta_T$ in the closed interval $[\varepsilon, 1]$, where $0<\varepsilon<1$. Because $\Delta W_T(\delta_T)$ is a continuous function on $[\varepsilon, 1]$, $\Delta W_T(\delta_T)$ will attain extreme values on this closed interval. Consider the first-order derivative:
    \begin{align*}
        \Delta W(\delta_T)' &=-\gamma  G\left(\beta \Delta +(1-\delta_T)\gamma \right)+\int_0^{\beta \Delta }\frac{c}{\delta_T^2}g(c/\delta_T)dc \\
            &= -\gamma \left[1-\exp\left(-\frac{\beta \Delta +(1-\delta_T)\gamma }{\gamma }\right)\right] \\
            &\quad -\frac{\beta \Delta}{\delta_T} \exp\left(-\frac{\beta \Delta}{\delta_T \gamma}\right)-\gamma\left[\exp\left(-\frac{\beta \Delta}{\delta_T \gamma}\right)-1\right] \\
            &= \gamma \left[\exp\left(-\frac{\beta \Delta +(1-\delta_T)\gamma }{\gamma }\right)-\exp\left(-\frac{\beta \Delta}{\delta_T\gamma}\right)\right]-\frac{\beta \Delta}{\delta_T}\exp \left(-\frac{\beta \Delta}{\delta_T \gamma}\right)   
    \end{align*}
    Note that $\lim_{\delta_T\rightarrow 0^{+}}\Delta W(\delta_T)' = \gamma \exp\left(-\frac{\beta \Delta+\gamma}{\gamma}\right)>0$. By the continuity of function $\Delta W(\delta_T)$, there always exist  a $\varepsilon \in (0,\,1)$ that is close to zero such that $\Delta W(\varepsilon)>0$. The second-order derivative of $\Delta W_T$ with respect to $\delta_T$ is:
    \begin{align*}
        \Delta W(\delta_T)'' = 
    \end{align*}

    $\Rightarrow  \Delta W(\delta_T)' < 0.$     
 
    This implies that $\Delta W(\delta_T)$ attains its maximum value at $\varepsilon$ on the interval $\varepsilon$ and $\Delta W(\varepsilon)>0$. Because $\varepsilon$ can be arbitrarily small, we have $\Delta W(\delta_T)>0$ for any $\delta\in(0, 1)$. 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{A Flexible Empirical Framework}\label{Sec2}
In this section, I first briefly lay out a standard model of dynamic model with R\&D investment and patents. The basic structure of the model is similar to that considered in \cite{Awetal.2011,Doraszelski2013,Peters2016, Peters2017}, with the exception that both R\&D and patents play a role in shifting the future productivity. 

\subsection{A Model of R\&D Investment}

\paragraph{Production and Profits} A firm has a Cobb-Douglas production function
\begin{equation}
Q_{it} = \Phi_{it}K_{it}^{\beta_{k}}L_{it}^{\beta_l}M_{it}^{\beta_m}\exp{(\beta_a a_{it})}
\end{equation}
where $Q_{it}$ is the physical output of firm $i$ in period t, $\Phi_{it}$ is the total factor productivity, $K_{it}$ is the capital, $L_{it}$ is the labor, $M_{it}$ is the material, $a_{it}$ is the firm's age. Consider a well-behaved inverse demand equation
\begin{equation}
    p_{it} = D(Q_{it})
\end{equation}
where $p_{it}$ is the output price. To simplify the analysis, we assume that a firm treats capital and productivity as predetermined when choosing labor and materials in each period. Let $\Pi(\phi_{it},\mathbf{S}_{it})$ be the optimal profits, and $R(\phi_{it},\mathbf{S}_{it})$ be the revenue, where $\phi_{it}=\ln(\Phi_{it})$, $\mathbf{S}_{it}=(K_{it}, P_{Lit}, P_{Mit}, a_{it})$ is a vector of exogenous state variables. The cost minimization implies that
\begin{equation}
    \Pi(\phi_{it},\mathbf{S}_{it}) = (1-\frac{\beta_l+\beta_m}{\theta_{it}})R(\phi_{it},\mathbf{S}_{it})
\end{equation}
where $\theta_{it}$ is the markup. Note that when $\beta_l+\beta_m=1$, the production function is of constant return to scale in terms of $L_{it}$ and $M_{it}$.

\paragraph{Productivity evolution}The firm's productivity $\phi_{it}$ is unobserved by the econometrician. R\&D investment and patenting enter the Markov process governing the productivity evolution. In particular, the dynamics of the productivity is given by
\begin{equation}
    \phi_{it+1} = h(\phi_{it},d_{it},\mathbf{o}_{it+1})+\epsilon_{it+1}
\end{equation}
where $d_{it}$ represents the R\&D investment and $\mathbf{o}_{it+1}$ is a vector summarizing the innovation outcome next period, and $\epsilon_{it+1}$ is an iid shock with a mean-zero normal distribution. Considering different types of innovation output, $\mathbf{o}_{it}$ can be a vector of process innovation and product innovation measured by the patents or other observed indicators. The marginal effects of R\&D investment and innovation output are captured by three partial derivatives $\partial h/\partial d_{it}$, $\partial h/\partial \mathbf{o}_{it+1}$, and a cross derivative $\partial ^2h/\partial d_{it} \partial \mathbf{o}_{it+1}$. Because R\&D is the fundamental source of productivity change, we impose that $ \partial h(\phi_{it}, 0, \mathbf{o}_{it+1})/\partial\mathbf{o}_{it+1} = \mathbf{0}$. This implies that without R\&D investment, we should expect no endogenous productivity growth, though we can see productivity growth through the channel of exogenous shocks. The cross-derivative $\partial ^2h/\partial d_{it} \partial \mathbf{o}_{it+1}$ deserves some discussion. When positive, it means that the stimulating impact of R\&D on productivity is strengthened through the patenting. This indicates that the patenting system help firms protect their inventions. When negative, we anticipate that the effect of knowledge spillovers dominates so that firms productivity improves less by patenting. This may be due to the weak patenting system.

Following CDM, I assume that patents is a random variable of which the distribution is determined by R\&D investment. This assumption greatly simplifies the analysis by only considering the R\&D investment choice. Specifically, patents outcome in next period is assumed to be a distribution depending on past R\&D. The distribution of $\mathbf{o}_{it+1}$ is given by $Pr(\mathbf{o}_{it}\leq \mathbf{o}) = G(\mathbf{o};d_{it})$.\footnote{In the reduce-form analysis, this process is usually estimated using count data models. See \cite{hall1989research,hall2010}.} This layer of uncertainty is similar to that considered in PRVF. Note the Markovian property implies that the conditional expectation of future productivity is 
\begin{equation*}
    \mathbf{E}(\phi_{it+1}|\phi_{it}, d_{it})=\int h(\phi_{it},d_{it},\mathbf{o})dG(\mathbf{o};d_{it})
\end{equation*}
Therefore R\&D investment can influence future productivity through affecting $h(\phi_{it}, d_{it},\mathbf{o})$ and the distribution of innovation output $G(\mathbf{o}; d_{it})$. This allows me to decompose the impact of R\&D into patenting and non-patenting channels.


\paragraph{Recursive formulation}
To consider a general setting, denote $C(d_{it}, \mathbf{X}_{it})$ as the variable costs of R\&D investment. Here $\mathbf{X}_{it}=(\mathbf{S}_{it}, \mathbf{Z}_{it})$, $\mathbf{Z}_{it}$ is the additional exogenous states that influence the costs of R\&D investment.\footnote{For example, $\mathbf{Z}_{it}$ may contain past R\&D investment decisions so the R\&D costs also include adjustment costs.} In addition, there is a fixed cost of R\&D investment, denoted as $f(\mathbf{X}_{it})$. With this fixed costs, the model can capture the innovation choice at the extensive margin. Note that we allow the exogenous state variables to affect the costs of R\&D. Omitting the subscripts, the firm's dynamic programming problem can be written in a recursive formulation:
\begin{equation}\label{VF_full}
    V(\phi, \mathbf{X}) =\max_{d}\left\{V^0(\phi, \mathbf{X}), V^d(\phi, \mathbf{X})\right\} 
\end{equation}
where the value functions for different choices of $d$ are
\begin{align}
    V^0(\phi)&=\Pi(\phi,\mathbf{X})+ \beta \mathbf{E}\left[ V(\phi', \mathbf{X}')|d=0\right], \\
    V^d(\phi)&=\max_{d} \left\{ \Pi(\phi,\mathbf{X})-C(d, \mathbf{X}) - f(\mathbf{X}) + \beta \mathbf{E}\left[ V(\phi', \mathbf{X}')|d\right]\right\}, \label{VF_d}
\end{align}
where $\beta$ is the discounting factor. We assume that firms have perfect foresight for the exogenous state variables. This allows us to calculate the expected firm value as
\begin{equation}\label{EV_d}
    \mathbf{E}\left[ V(\phi', \mathbf{X}')|d\right] = \int\int V(h(\phi,d,\mathbf{o})+\epsilon,\mathbf{X}')dG(\mathbf{o};d)dF(\epsilon)
\end{equation}
where $F(\cdot)$ is the distribution of $\epsilon'$. 
A stochastic equilibrium of the model is a decision rule $d(\phi, \mathbf{X})\geq0$ such that the recursive problem (\ref{VF_full}) is solved.
\subsection{Benefits of R\&D and Patent Value}
\paragraph{Decomposition of the returns of R\&D} 
Following PRVF, I define the long-run benefits of R\&D investment as relative change in the expected firm value caused by R\&D investment. One novelty in this paper is that I decompose the R\&D benefits into patenting and non-patenting channels. For what follows, I use the notation of partial derivatives by assuming that both $d$ and $d$ and $\mathbf{o}$ are continuous variables and we consider the continuous region in the value function to simplify the notation. Using (\ref{EV_d}), I decompose the benefit of innovation as:
\begin{align}  \label{LB}
    LB(\phi,\mathbf{X})& = \frac{\partial \ln[\mathbf{E}(V(\phi',\mathbf{X}')|d)]}{\partial d} \\
                       & = \frac{1}{\mathbf{E}[V(\phi',\mathbf{X}')|d]} \int \left\{ \int \frac{\partial V(h+\epsilon,\mathbf{X}')}{\partial d}dG(\mathbf{o};d) + \int V(h+\epsilon,\mathbf{X}')dg(\mathbf{o};d) \right \}dF(\epsilon) \nonumber
\end{align}
where $g(o;d_{it})$ is the density function. This provides a decomposition of firm value change into two channels. The first term on in the big bracket captures the direct impact of R\&D on future firm value, which is the non-patenting channel. R\&D investment also influences the distribution of innovation outcome, this impact is captured in the second term. Notice that in models with only R\&D investment enters the productivity evolution (like \citet{Doraszelski2013}), only the first term appears. In the model where only innovation outcome matters for productivity (such as \citet{Peters2017}), only the second term shows up. Specification (\ref{LB}) nests them as special cases. As a result, the benefits of innovation can be viewed as a composition of two parts:
\begin{align}
    LB_{N}(\phi,\mathbf{X})&= \frac{1}{\mathbf{E}[V(\phi',\mathbf{X}')|d]} \int\int \frac{\partial V(h+\epsilon,\mathbf{X}')}{\partial d}dG(\mathbf{o};d)dF(\epsilon), \\
    LB_{P}(\phi, \mathbf{X})&=   \frac{1}{\mathbf{E} [V(\phi',\mathbf{X}')|d]}\int\int V(h+\epsilon,\mathbf{X}')dg(\mathbf{o};d)dF(\epsilon), \label{LB_P}
\end{align}
where $LB_{N}$ is the part of R\&D returns without patenting, $LB_{P}$ represents the portion of the benefits of R\&D realized through patenting. Though we use patents as an example here, this decomposition strategy can also be directly applied to models in which innovation input and output differs. The underlying assumption in my model is conditional on the observed innovation output, R\&D still plays a role in affecting the firm performance.
\paragraph{Patent value}
To obtain the value of patents, we need to fix the firm's R\&D investment so that the benefits of R\&D is not confounded with the value of patents in determining the firm value. We then compute the increase change in the firm value by exogenously adjusting the value of innovation output. Let $\mathbf{E}[V(\phi',\mathbf{X}')|d,\mathbf{o'}]$ be the expected firm value conditional on R\&D investment and innovation output, we obtain that
\begin{equation}\label{EV_do}
    \mathbf{E}[V(\phi',\mathbf{X}')|d,\mathbf{o'}] = \int V(h(\phi,d,\mathbf{o}'),\mathbf{X}')dF(\epsilon)
\end{equation}
Note that we remove the uncertainty in generating innovation output by conditioning on $\mathbf{o'}$. Then we differentiate the log-form of (\ref{EV_do}) with respect to $\mathbf{o}'$ and obtain an estimator for the patent value:
\begin{align}
    PV(\mathbf{o}', d) &=  \frac{\partial \ln [\mathbf{E}(V(\phi',\mathbf{X}'|d,\mathbf{o}')]}{\partial \mathbf{o'}} \\
                     &=  \frac{1}{\mathbf{E} [V(\phi',\mathbf{X}')|d, \mathbf{o}']} \int\frac{\partial V(h(\phi,d,\mathbf{o}')+\epsilon,\mathbf{X}')}{\partial \mathbf{o}'}dF(\epsilon) \nonumber
\end{align}
Notice $PV(\mathbf{o}',d)$ has a dimension identical to $\mathbf{o}'$. Let $o_{j}$ be the $j^{th}$ element in $\mathbf{o}$. We call $o_j$ as the outcome of $j$-type innovation. Also let's denote $\mathbf{o}_{-j}$ as a vector of elements in $\mathbf{o}$ excluding $o_j$. In particular, if $\mathbf{o}\in \mathbf{R}^n$, $\mathbf{o}_{-j}=(o_1,\cdots,o_{j-1},o_{j+1},\cdots,o_n)$. In principle, there are interacting effects among different elements in $\mathbf{o}'$. That is, the value of $j$-type innovation $PV_j(\mathbf{o}',d)$ varies by $\mathbf{o}'_{-j}$. To avoid this complication, we compute the average value of each type of patent by using the distribution of $\mathbf{o}'_{-j}$ conditional on $j$-type innovation and R\&D investment $d$. Given the joint distribution $G(\mathbf{o}';d)$, the conditional distribution $G(\mathbf{o}_{-j}'|o_j',d)$ is given by
\begin{equation*}
    G(\mathbf{o}'_{-j}|o_j',d) =\int \frac{g(\mathbf{o}';d)}{g_j(o_j';d)}d\mathbf{o}_{-j}'
\end{equation*} 
where $g_j(o_j;d)=\int g(\mathbf{o}';d)d\mathbf{o}_{-j}'$ is the the marginal density function of $o_j$. Employing this probability distribution, we define the value of $j$-type innovation output as
\begin{align}
    EPV_j(o_j,d) = \int PV(\mathbf{o}',d)dG(\mathbf{o}'_{-j}|o_j,d).
\end{align}
Notice that the calculation of $EPV_j$ does not depend on the realizations of $\mathbf{o}'_{-j}$. The conditional expectation also characterizes the linkages between different types of innovation output. 
\paragraph{Extensive margin of R\&D} R\&D data often contains measurement error, and patent data are count data. This encourages researchers to  This situation can easily be accommodated by the empirical framework in this paper. Now we consider the R\&D choice $d\in\{0,1\}$ and patent count data $o_j\in\mathbb{N}$. We only need to slightly change the notation. First, the R\&D benefits is defined only at the extensive margin:
\begin{equation}
    DLB(\phi,\mathbf{X}) =\ln\mathbf{E}[V(\phi',\mathbf{X}')|d=1]-\ln\mathbf{E}[V(\phi',\mathbf{X}')|d=0]
\end{equation}
Using a similar decomposition, the non-patenting and patenting benefits are:
\begin{align}
    DLB_N(\phi,\mathbf{X}) =& G(\mathbf{0};d=1)\left\{\int \ln V(h(\phi,d=1,\mathbf{0}),\mathbf{X}')dF(\epsilon)-\ln\mathbf{E}[V(\phi',\mathbf{X}')|d=0]\right\} \label{DLB_N} \\ 
    DLB_P(\phi,\mathbf{X}) =&\int \int_{\mathbf{o}>\mathbf{0}}\left\{\ln V(h(\phi,d=1,\mathbf{0}),\mathbf{X}')-\ln\mathbf{E}[V(\phi',\mathbf{X}')|d=0]\right\}dG(\mathbf{o};d=0)dF(\epsilon) \label{DLB_P}
\end{align}
where $G(\mathbf{0};d=1)$ is the probability that no patent generated and $\mathbf{o}>\mathbf{0}$ means that each element in $\mathbf{o}$ is strictly positive. These two expressions are simply a discrete version of the decomposition introduced before. To consider the patent value, we can define the value of $j$-type innovation output as 
\begin{equation} \label{patent_value}
    DEPV_j(o_j,d) = \int PV(\mathbf{o}',d=1)dG(\mathbf{o}'_{-j}|o_j,d=1)-\int PV(\mathbf{o}',d=1)dG(\mathbf{o}'_{-j}|o_j-1,d=1)
\end{equation}
Note $G(\mathbf{o}'_{-j}|o_j-1,d=1)$ captures the probabilistic distribution of all types when no $j$-type patent is generated. Once again, the patent value is defined as the marginal change in the expected firm value generated by increasing the number $j$-type patent by one. 






\section{Computation}
I refer to \citet{farmer2017} for the discretization of non-linear Markov process. The implementation of nested fixed point algorithm is explained below.

\subsection{Preparation}
\paragraph{Profit function}

I normalize the productivity with the constant $\mu_{0}$ in the
empirical model. From the estimation equation, we can write the profit
as:
\begin{equation}
\hat{r}_{it}\left(\hat{\phi}_{it}\right)=\hat{\mu}_{0}+\hat{\mu}_{t}+\left(1-\hat{\sigma}_{j}\right)\hat{\rho}_{0}+\left(1-\hat{\sigma}_{j}\right)\hat{\beta}_{k}k_{it}+\left(1+\hat{\theta}_{j}\right)\hat{\beta}_{a}a_{it}-\left(1+\hat{\theta}_{j}\right)\hat{\phi}_{it}
\end{equation}
It follows that the profit can be calculated as 
\begin{equation}
\pi_{it}\left(\hat{\phi}_{it}\right)=-\frac{1}{\hat{\theta}_{j}}\exp\left(\hat{r}_{it}\left(\hat{\phi}_{it}\right)\right)
\end{equation}

\paragraph{Choose the grid points}

We perform the computation by industry. Several coefficients are specific
to each industry: $\mu_{0}$, $\rho_{0}$, and $\sigma_{j}$. Note
that we discretize the productivity into 200 grid points, and age
into 4 groups. To implement the estimation, I use the trapezoid method
to discretize the capital space in evenly distributed 100 points.
Therefore, we are encountered with $100\times4\times4=1600$ types
of firms. For each type of firm, we solve the value function for $100\times2=200$
states. In the end, we solve $1600\times200=320000$ value functions.
We compute the value function by industry by industry. 

\subsection{Inner loop: Value function iteration}

Given $\left(\phi_{it},\,k_{it},\,a_{it}\right),$ we use $V_{d}$
to denote $V\left(\phi_{it},d_{it-1}=d;\,k_{it},a_{it}\right)$.
We also define $\gamma_{it}^{d}\equiv\gamma_{it}\left(d_{it-1}=d,k_{it};\,\kappa^{m},\,\kappa^{s}\right)$,
for $d\in\left\{ 0,\,1\right\} $, and $\kappa\equiv\left(\kappa^{s},\,\kappa^{m}\right)$
be the parameter to be estimated. Employing the exponential distribution,
we can express the value function as 
\begin{align*}
V_{d} & =\Pi_{it}\left(\phi_{it},\mathbf{S}_{it}\right)+\int_{0}^{\Delta \mathbf{E}V}\left(\beta\mathbf{E}V_{1}-c\right)dH\left(c\right)+\beta\int_{\Delta \mathbf{E}V}^{\infty}\mathbf{E}V_{0}dG\left(c\right)\\
 & =\Pi_{it}\left(\phi_{it},\mathbf{S}_{it}\right)+ \beta \mathbf{E}V_{1}\left[1-\exp(-\frac{\Delta\mathbb{E}V}{\gamma_{it}^{d}})\right]+\left(\Delta \mathbf{E}V+\gamma_{it}^{d}\right)\exp\left(-\frac{\Delta\mathbb{E}V}{\gamma_{it}^{d}}\right)\\
 & -\gamma_{it}^{d}+\mathbf{E}V{}_{0}\exp\left({-\frac{\Delta\mathbb{E}V}{\gamma_{it}^{d}}}\right)
\end{align*}
where $\Delta \mathbf{E}V=\beta\mathbf{E}V_{1}-\beta\mathbf{E}V_{0}$. Therefore the expression of $V_{d}$
can be simplified as 
\begin{equation}
V_{d}=\Pi_{it}\left(\phi_{it},\mathbf{S}_{it}\right)+\gamma_{it}^{d}\left(\exp\left(-\frac{\Delta \mathbf{E}V}{\gamma_{it}^{d}}\right)-1\right)+\mathbf{E}V_{1},\,\text{for }d\in\left\{ 0,\,1\right\} \label{Vd}
\end{equation}
In computing the value functions, $V_{d}$ is a $200$ by 1 vector
given capital, age, and industry. Let $p_{mn}=Pr\left(n_{t+1}=m,b_{t+1}=n|d_{t}=1\right)$,
for $m,\,n\in\left\{ 0,1\right\} $, and further denote $P_{mn}$
as the corresponding transition matrix of the productivity and $P_{0}$
as the transition matrix of productivity when $d_{t}=0$. then Equation
(\ref{Vd}) can be transformed as 
\begin{align}
V_{1} & =\Pi\left(\phi\right)-\beta\gamma^{1}\left(1-\exp\left(-\frac{\Delta EV}{\gamma^{1}}\right)\right)+\beta\left(\sum_{m}\sum_{n}p_{mn}P_{mn}\right)V_{1}\label{V1}\\
V_{0} & =\pi\left(\phi\right)-\beta\gamma^{0}\left(1-\exp\left(-\frac{\Delta EV}{\gamma^{0}}\right)\right)+\beta\left(\sum_{m}\sum_{n}p_{mn}P_{mn}\right)V_{1}\label{V0}
\end{align}
Denote $P_{1}=\beta\left(\sum_{m}\sum_{n}p_{mn}P_{mn}\right)$, then
\[
V_{1}=\left(I-\beta P_{1}\right)^{-1}\left[\pi\left(\phi\right)-\beta\gamma^{1}\left(1-\exp\left(-\frac{\Delta EV}{\gamma^{1}}\right)\right)\right]
\]
 because $\Delta EV=P_{1}V_{1}-P_{0}V_{0}$, it follows that:
\begin{align}
\Delta EV & =\left(I-\beta P_{0}\right)P_{1}\left(I-\beta P_{1}\right)^{-1}\left[\pi\left(\phi\right)-\beta\gamma^{1}\left(1-\exp\left(-\frac{\Delta EV}{\gamma^{1}}\right)\right)\right]\label{DEV}\\
 & \quad-P_{0}\left[\pi\left(\phi\right)-\beta\gamma^{0}\left(1-\exp\left(-\frac{\Delta EV}{\gamma^{0}}\right)\right)\right]\nonumber 
\end{align}
We use equation (\ref{DEV}) to solve for $\Delta EV$ and then we
use equations (\ref{V1}) and (\ref{V0}) to solve for $V_{1}$ and
$V_{0}$. Use $T_{\kappa}$ as the linear operator applied to $\Delta EV$,
it is easy to show that $T_{\kappa}$ is a contraction mapping. Then
$\Delta EV$ is a fixed point such that 
\[
T_{\kappa}\left(\Delta EV\right)=\Delta EV
\]
.Now we are in the position to use Newton-Kantorovich iterations.
First note that the Frech\'{e}t derivative of $T_{\kappa}$ with
respect to $\Delta EV$ is:
\begin{align}
T_{\kappa}' & =\frac{\partial T_{\kappa}\left(\Delta EV\right)}{\partial\Delta EV}\\
 & =\beta\left(\beta P_{0}-I\right)P_{1}\left(I-\beta P_{1}\right)^{-1}\exp\left[\text{diag}\left\{ -\frac{\Delta EV_{i}}{\gamma^{1}}\right\} \right]\nonumber \\
 & +\beta P_{0}\exp\left[\text{diag}\left\{ -\frac{\Delta EV_{i}}{\gamma^{0}}\right\} \right]\nonumber 
\end{align}
where 
\[
\text{diag}\left\{ -\frac{\Delta EV_{i}}{\gamma^{d}}\right\} =\left[\begin{array}{cccc}
-\frac{\Delta EV_{1}}{\gamma^{d}} & 0 & \cdots & 0\\
0 & -\frac{\Delta EV_{2}}{\gamma^{d}} & \cdots & 0\\
\vdots & \vdots & \ddots & \vdots\\
0 & 0 & \cdots & -\frac{\Delta EV_{n}}{\gamma^{d}}
\end{array}\right]
\]
Using the invertibility of $\left[I-T_{\kappa}'\right]$ the $n$th
iteration in the Newton-Kantorovich algorithm is 
\[
\Delta EV_{n+1}=\Delta EV_{n}-\left[I-T_{\kappa}'\right]^{-1}\left(I-T_{\kappa}\right)\left(\Delta EV_{n}\right)
\]
We set the tolerance as $e^{-6}$; the iteration stops when $\|\Delta EV_{n+1}-\Delta EV_{n}\|\leq e^{-6}$. 

\subsection{Outer loop: BHHH optimization algorithm}

The outer loop solves following problem:
\[
\max_{\kappa^{s},\kappa^{m}}\sum_{i}\sum_{t}l_{it}\left(\kappa,\,\Delta EV_{it}\right)
\]
 where 
\begin{align}
l_{it}\left(\kappa,\,\Delta EV_{it}\right) & =\log\left\{ d_{it}Pr\left(d_{it}=1|\kappa,d_{it-1}\right)+\left(1-d_{it}\right)Pr\left(d_{it}=0|\kappa,d_{it-1}\right)\right\} \label{llf}\\
 & =\log\left\{ \left(2d_{it}-1\right)\Pr\left(d_{it}=1|\kappa,d_{it-1}\right)+1-d_{it}\right\} \nonumber 
\end{align}
where $\Delta EV_{it}=\Delta EV\left(\phi_{it}\right)$ and 
\begin{align}
Pr\left(d_{it}=0|\kappa,d_{it-1}\right) & =1-Pr\left(d_{it}=1|\kappa,d_{it-1}\right)\\
 & =\exp\left\{ \frac{-\beta\Delta EV\left(\phi_{it}\right)}{\kappa^{m}d_{it-1}k_{it}+\kappa^{s}\left(1-d_{it-1}\right)k_{it}}\right\} \nonumber 
\end{align}
The basic parameter iteration under BHHH algorithm is:
\begin{align*}
\kappa_{n+1} & =\kappa_{n}+\lambda\underset{\equiv D\left(\kappa_{n}\right)}{\underbrace{\left[\sum_{i,t}\left(\frac{\partial l_{it}\left(\kappa_{n},\,\Delta EV_{it}\right)}{\partial\kappa_{n}}\right)\left(\frac{\partial l_{it}\left(\kappa_{n},\,\Delta EV_{it}\right)}{\partial\kappa_{n}'}\right)\right]^{-1}\left(\sum_{i,t}\frac{\partial l_{it}\left(\kappa_{n},\,\Delta\right)}{\partial\kappa_{n}}\right)}}
\end{align*}
From (\ref{llf}) we know that 
\begin{equation}
\frac{\partial l_{it}\left(\kappa_{n},\,\Delta EV_{it}\right)}{\partial\kappa_{n}'}=w_{it}\left[\frac{\partial Pr\left(d_{it}=1|\kappa,d_{it-1}\right)}{\partial\kappa_{n}^{s}},\,\frac{\partial Pr\left(d_{it}=1|\kappa,d_{it-1}\right)}{\partial\kappa_{n}^{m}}\right]
\end{equation}
where
\begin{align*}
w_{it} & =\frac{\left(2d_{it}-1\right)}{\left(2d_{it}-1\right)\Pr\left(d_{it}=1|\kappa,d_{it-1}\right)+1-d_{it}}\\
\frac{\partial Pr\left(d_{it}=1|\kappa,d_{it-1}\right)}{\partial\kappa_{n}^{s}} & =\beta\frac{\frac{\partial\Delta EV_{it}}{\partial\kappa_{n}^{s}}\gamma_{it}^{d_{it-1}}-\left(1-d_{it-1}\right)k_{it}\Delta EV_{it}}{\left(\gamma_{it}^{d_{it-1}}\right)^{2}\exp\left(\frac{\beta\Delta EV_{it}}{\gamma_{it}^{d_{it-1}}}\right)}\\
\frac{\partial Pr\left(d_{it}=1|\kappa,d_{it-1}\right)}{\partial\kappa_{n}^{m}} & =\beta\frac{\frac{\partial\Delta EV_{it}}{\partial\kappa_{n}^{m}}\gamma_{it}^{d_{it-1}}-d_{it-1}k_{it}\Delta EV_{it}}{\left(\gamma_{it}^{d_{it-1}}\right)^{2}\exp\left(\frac{\beta\Delta EV_{it}}{\gamma_{it}^{d_{it-1}}}\right)}
\end{align*}
where $\frac{\partial\Delta EV_{it}}{\partial\kappa^{s}}$ ($\frac{\partial\Delta EV_{it}}{\partial\kappa^{m}}$)
is the element in 1st (2nd) column such that the corresponding productivity
in the row is $\phi_{it}$. To finish the nested fixed point algorithm,
we need to compute the derivatives of the expected value function,
$\partial\Delta EV/\partial\gamma$. Applying the implicit theorem
to $T_{\kappa}\left(\Delta EV\right)=\Delta EV$, we get 
\[
\frac{\partial\Delta EV}{\partial\kappa}=\left[I-T_{\kappa}'\right]^{-1}\frac{\partial T_{\kappa}\left(\Delta EV\right)}{\partial\kappa}
\]
From (\ref{DEV}), we know that 
\begin{align*}
\frac{\partial T_{\kappa}\left(\Delta EV\right)}{\partial\kappa} & =\left[\begin{array}{cc}
\frac{\partial T_{\kappa}\left(\Delta EV\right)}{\partial\kappa^{s}} & ,\frac{\partial T_{\kappa}\left(\Delta EV\right)}{\partial\kappa^{m}}\end{array}\right]
\end{align*}
where 
\begin{align*}
\frac{\partial T_{\kappa}\left(\Delta EV\right)}{\partial\kappa^{m}} & =\beta k\left(\beta P_{0}-I\right)P_{1}\left(I-\beta P_{1}\right)^{-1}\left[1-\exp\left(\frac{-\Delta EV}{\gamma^{1}}\right)-\frac{\Delta EV}{\gamma^{1}}\varodot\exp\left(\frac{-\Delta EV}{\gamma^{1}}\right)\right]\\
\frac{\partial T_{\kappa}\left(\Delta EV\right)}{\partial\kappa^{s}} & =\beta kP_{0}\left[1-\exp\left(\frac{-\Delta EV}{\gamma^{0}}\right)-\frac{\Delta EV}{\gamma^{0}}\varodot\exp\left(\frac{-\Delta EV}{\gamma^{0}}\right)\right]
\end{align*}
are both $200$-by-$1$ vectors and $k$ is the exogenous state variable:
capital stock. We use $\varodot$ to denote the element-wise product.
To determine the step size $\lambda,$ we use secant iteration to
find the solution to $\partial f\left(\lambda\right)/\partial\kappa=0$,
where $f\left(\lambda\right)\equiv L\left(\kappa+\lambda D\left(\kappa\right)\right)$.
The iteration is given as:
\begin{equation}
\lambda_{m+1}=\lambda_{m}-\frac{\left(\lambda_{m}-\lambda_{m-1}\right)f'\left(\lambda_{m}\right)}{f'\left(\lambda_{m}\right)-f'\left(\lambda_{m-1}\right)}
\end{equation}
where 
\begin{equation}
f'\left(\lambda_{m}\right)=\sum_{i,t}\frac{\partial l_{it}\left(\kappa+\lambda_{m}D\left(\kappa_{n}\right),\,\Delta EV_{it}\right)}{\partial\kappa'}D\left(\kappa_{n}\right)
\end{equation}
This iteration determines the optimal step size $\lambda^{*}$. Finally,
the iteration stops when $\|\kappa_{n+1}-\kappa_{n}\|\leq e^{-6}$. 

\paragraph{Preliminary analysis on innovation and productivity}
In this subsection, I provide
preliminary evidence supporting that patent activities,especially on the extensive margin, is an important
channel for firms to realize the impact of R\&D on productivity and
hence profits. I use value added per employee as the measure of productivity,
denoted as $lp$. This variable is usually used
as a measure of labor productivity. In the econometric model, I use
the $lp_{t+1}$ as the dependent variable, and use $lp_{t}$, $rd_{t}$,
and its interactions with variables on patent activities as explanatory
variables. 

Table \ref{T8} reports the estimation results for different
explanatory variables. In column (1), I only use current productivity
and lagged binary indicator for R\&D as independent variables. As expected, the
coefficient of $rd_{t}$ is positive and significant. Column (2) shows the coefficient estimates
after we add the interaction term between R\&D status and invention
patents (denoted as $rd_{t}\times inpat_{t+1}$) to the empirical
model. We find that the coefficient estimate of $rd_{t}$ decreases
compared to that in column (1). The coefficient of $rd_{t}\times inpat_{t+1}$
is positive and statistically significant at 0.1\% significance level.
More importantly, the magnitude of the estimate of the coefficient
of $rd_{t}\times inpat_{t+1}$ is even larger than the estimate of
coefficient of $rd_{t}$, implying that patents is an important channel
through which the investment in R\&D contributes to the productivity
growth. In comparison, column (3) shows that the contribution of utility
patents to the realization of productivity-enhancing effect of R\&D
activities is not statistically significant. Columns (4) and (5) shows
that the interactive effect between invention patents and utility
patents may not be so important for past R\&D activities to increase
future productivity. To some extent, these results suggest that the
patent, especially invention patent, is an important channel through
which R\&D drives up the firm's future productivity. However,
we need to be cautious about interpreting our estimation results.
First, our measure of productivity is not clean as it contains information
on the capital intensity. Second, unobserved factors that affects
capital accumulation as well as firm's R\&D choice may cause endogeneity
problem to the preliminary specification. In all regressions, I control for industry, year, and industry-year fixed effects. 

As additional supporting evidence for that the extensive margin of
patents matters more in terms of realizing the productivity-promoting
effect of R\&D, I also try to re-estimate our models using a sub-sample
containing firms that filed at least one patent application. I
report the estimation results in Table \ref{T9}. As we can see from
the results, the estimates for coefficients of $rd_{t}\times inpat_{t+1}$
and $rd_{t}\times utpat_{t+1}$ are not statistically significant
though the coefficient estimate for $rd_{t}$ is significant in columns
(1) and (2). These results confirm that change in the extensive margin
of patent applications is more important in explaining the different
impacts of R\&D on productivity growth. 

\begin{center}
Table \ref{T8} here
\par\end{center}

\begin{center}
Table \ref{T9} here
\par\end{center}

The R\&D-patent and innovation-productivity linkages are two important components of our structural model. In light of the discussion above, we use 0-1 binary variables to measure the R\&D activities, invention patents applications, and utility patents applications. Specifically, we use $rd$, $n$, and $b$ to represent the investment in R\&D, application of invention
patents, and application of utility patents. $rd$ is equal to one
when the firm invests in R\&D; similar definitions are applied to
$n$ and $b$. Throughout our discussion, we do not consider design patents. 



\begin{table}[H]
\centering
\caption{Impact of R\&D and patents on productivity: extensive margin of patents}
\label{T8}
\input{Table8.tex}
\caption*{\small{}Note: all regression contain industry and industry-year fixed effects. Standard errors in parentheses.{*} \(p<0.05\), {**} \(p<0.01\), {***} \(p<0.001\)} {\small \par}
\end{table}


\begin{table}[H]
\centering
\caption{Impact of R\&D and patents on productivity: intensive margin of patents}
\label{T9}
\input{Table9.tex}
\caption*{\small{}Note: all regression contain industry and industry-year fixed effects. Standard errors in parentheses.{*} \(p<0.05\), {**} \(p<0.01\), {***} \(p<0.001\)} {\small \par}
\end{table}